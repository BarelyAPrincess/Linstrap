error()
{
	echo $*
	return 1
}

try_mount()
{
	RW=$1; shift
	case $(blkid $1) in
		*TYPE=*ntfs*)
			mount.ntfs-3g -o rw,force $@
			;;
		*TYPE=*)
			mount -o $RW,noatime $@
			;;
		*)
			return 1
			;;
	esac
}

remount_rw()
{
	# "foo" as mount source is given to workaround a Busybox bug with NFS
	# - as it's ignored anyways it shouldn't harm for other filesystems.
	mount -o remount,rw foo /mnt
}

check_root()
{
	if [ "`dirname $1`" = "/dev" ]; then
		[ -e $1 ] || return 1
		blk=`basename $1`
		[ ! -e /dev/block/$blk ] && ln $1 /dev/block
		dev=/dev/block/$blk
	else
		dev=$1
	fi

	try_mount ro $dev /mnt || return 1
	if [ -e /mnt/$SRC/linstrap.img ]; then
		remount_rw
		mount -o loop,noatime /mnt/$SRC/linstrap.img linstrap
	elif [ -s /mnt/$SRC/linstrap/default.prop ]; then
		remount_rw
		mount --bind /mnt/$SRC/linstrap linstrap
	elif [ -z "$SRC" -a -s /mnt/default.prop ]; then
		mount --bind /mnt /linstrap
	else
		return 1
	fi
	echo " found at $1"
	rm /sbin/mke2fs
	hash -r
}

# Allows for the starting of DEBIRF if initrd is not acting right
if [ "$RESCUE" -gt "0" ]; then
	mkdir /newroot
	MEMSIZE=$(free | grep 'Mem:' | awk '{ print $2 }')
	mount -t tmpfs -o size=${MEMSIZE}k,mode=0755 tmpfs /newroot
	cd /newroot
	echo unpacking rootfs...
	unxz - < /rootfs.cxz | cpio -i
	umount /proc
	echo running /sbin/init...
	exec /bin/run-init . /sbin/init < ./dev/console > ./dev/console

	# Should never reach this line
fi

KERNEL_MODULES="/lib/modules/$(uname -r)"
[ -e "$KERNEL_MODULES" ] && echo "CRITICAL ERROR: We detected that the kernel does not have any valid modules present. There may be issues with some hardware."

# ensure keyboard driver is loaded
busybox modprobe -a atkbd hid-apple

echo -n Detecting Linstrap Launcher...

[ -z "${SRC}" ] && [ -n "${BOOT_IMAGE}" ] && SRC=$(dirname "${BOOT_IMAGE}")

cd /
while :; do
	for device in ${ROOT:-/dev/[hmnsv][dmrv][0-9a-z]*}; do
		[ -n "${DEBUG}" ] && echo -en "\nTrying device ${device}"
		check_root "${device}" && break 2
		mountpoint -q /mnt && umount /mnt
	done

	while :; do
		echo -e "\n\nIt would appear we were unable to find the Linstrap Launcher."
		echo "What would you like to do, [R]etry or [D]rop to shell?"
		read OPT
		case ${OPT} in
			"r" | "R")
				# Do Nothing
				break;
				;;
			"d" | "D")
				echo
				echo '	Linstrap console shell. Use only in emergencies.'
				echo
				debug_shell fatal-error
				break
				;;
			* )	echo "That is not a valid option!";;
		esac
	done
done
cd /linstrap

# ln -s mnt/$SRC /src
# ln -s linstrap/system /
# ln -s ../system/lib/firmware ../system/lib/modules /lib

# load scripts
for s in $(ls /scripts/* /src/scripts/*); do
	test -e "$s" && source $s
done

#if [ -n "$DEBUG" ]; then
#	auto_detect &
#fi

if [ "${DEBUG:-0}" -gt 0 ]; then
	echo -e "\nType 'exit' to continue booting...\n"
	debug_shell debug-found
fi

# A target should provide its detect_hardware function.
# On success, return 0 with the following values set.
# return 1 if it wants to use auto_detect
#[ "$AUTO" != "1" ] && detect_hardware && FOUND=1

#load_modules
#mount_data
#mount_sdcard
#setup_tslib
#setup_dpi
#post_detect

if [ "${DEBUG:-0}" -gt 1 ]; then
	echo -e "\nUse Alt-F1/F2/F3 to switch between virtual consoles"
	echo -e "Type 'exit' to enter Linstrap...\n"

	debug_shell debug-late
fi

[ -n "$DEBUG" ] && SWITCH=${SWITCH:-chroot}

echo > /proc/sys/kernel/hotplug

exec ${SWITCH:-switch_root} /linstrap /init
