addMenuOption "Update Boot Disk" "bootDiskUpdate"

bootDiskUpdate() {
# Arg 2 is the target device
    DEVICE=${2:-/dev/sdm} # TODO Verify partition table
    DEVICE_BOOT=${DEVICE}3 # The boot partition
    DEVICE_ROOT=${DEVICE}4 # The root partition

    if [ -f ${DEVICE} ]; then
        echo
        msg "[:: Updating HoneyPotLinux Build ::]"

        # BUILD: Contains the active projects
        LINSTRAP_BUILD=${LINSTRAP_HOME}/build/${PROJECT}
        mkdir -vp ${LINSTRAP_BUILD}/{root,initrd,kernel} 2>/dev/null

        ## TODO Scan directories for changes, to know what needs to copied to the device
        bash -c "cd ${LINSTRAP_BUILD}/initrd && find * | cpio --create -H newc" | gzip -9 > ${LINSTRAP_BUILD}/initrd-honeypot.cgz

        ## Properly build new kernel
        [ ! -f ${LINSTRAP_BUILD}/kernel/arch/x86_64/boot/bzImage ] && bash -c "cd ${LINSTRAP_BUILD}/kernel && make -j24"

        echo
        msg "[:: Updating HoneyPotLinux Disk ::]"

        LINSTRAP_WORKDIR=${LINSTRAP_HOME}/workdir
        mkdir -vp ${LINSTRAP_WORKDIR}/{mount_boot,mount_root} 2>/dev/null
        LINSTRAP_WORKDIR_BOOT=${LINSTRAP_WORKDIR}/mount_boot
        LINSTRAP_WORKDIR_ROOT=${LINSTRAP_WORKDIR}/mount_root

        echo -n "Mounting ${DEVICE_BOOT} to ${LINSTRAP_WORKDIR_BOOT}..."
        mount -o noatime $DEVICE_BOOT ${LINSTRAP_WORKDIR_BOOT}
        echo "Done!"

        echo -n "Copying boot files..."
        cp -vu ${LINSTRAP_BUILD}/initrd-honeypot.cgz ${LINSTRAP_WORKDIR_BOOT}
        cp -vu ${LINSTRAP_BUILD}/kernel/arch/x86_64/boot/bzImage ${LINSTRAP_WORKDIR_BOOT}/vmlinuz-honeypot
        echo "Done!"

        echo -n "Mounting ${DEVICE_ROOT} to ${LINSTRAP_WORKDIR_ROOT}..."
        mount -o noatime $DEVICE_ROOT ${LINSTRAP_WORKDIR_ROOT}
        echo "Done!"

        ## TODO Cleanup root directory of any files that may have been created during a chroot session. Could this be done with a simple rsync ignore list?
        rsync -av --progress --delete ${LINSTRAP_BUILD}/root/ ${LINSTRAP_WORKDIR_ROOT} | xargs -i echo -ne "\rCopying root files... {}                            " && echo
        echo -e "\rCopying root files... Done!"

        echo -n "Unmounting..."
        #umount "${LINSTRA_WORKDIR}/mount_boot"
        #umount "${LINSTRA_WORKDIR}/mount_root"
        echo "Done!"

        echo
        echo "Finished!"
    else
        error "The device ${DEVICE} does not exist!"
    fi
}
